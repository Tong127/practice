<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¸­å’–å•¡å»³æ¨è–¦</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #4a5c6a 0%, #98a8AB  100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .search-bar {
            background: white;
            padding: 2rem;
            margin: -1rem auto 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            max-width: 850px;
            max-height: 300px;   
        }

        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            margin-bottom: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #4a5c6a;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #4a5c6a;
            color: white;
            border-color: #4a5c6a;
        }

        .cafe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .cafe-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
    font-family: "Noto Sans TC", sans-serif;
    color: #333;
        }

        .cafe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .cafe-image {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        .cafe-image span {
            position: relative;
            z-index: 2;
        }

        .cafe-content {
            padding: 1.5rem;
        }

        .cafe-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .cafe-location {
            color: #666;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cafe-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .feature-tag {
            background: #f8f9fa;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .cafe-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .stars {
            color: #ffc107;
        }

        .rating-text {
            color: #666;
            font-size: 0.9rem;
        }

        .district-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: #dc3545;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 2rem 0;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 2rem 0;
            overflow: hidden;
        }

        .map-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #4a5c6a 0%, #98a8AB  100%);
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        #map {
            height: 400px;
            width: 100%;
        }

        .view-toggle {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            justify-content: center;
        }

        .toggle-btn {
            padding: 0.8rem 1.5rem;
            border: 2px solid #4a5c6a;
            background: white;
            color: #4a5c6a;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .toggle-btn.active {
            background: #4a5c6a;
            color: white;
        }

        .cafe-popup {
            max-width: 250px;
        }

        .popup-content {
            padding: 0.5rem 0;
        }

        .popup-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .popup-address {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .popup-features {
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .popup-feature {
            background: #f0f0f0;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .popup-rating {
            font-size: 0.9rem;
            color: #ffc107;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .cafe-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><strong>å°ä¸­å’–å•¡å»³æ¨è–¦!!</strong></h1>
        </div>
    </div>

    <div class="container">
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="æœå°‹å’–å•¡å»³åç¨±æˆ–åœ°é»..." id="searchInput">
            
            <div class="district-filter">
                <button class="filter-btn active" data-district="all">å…¨éƒ¨å€åŸŸ</button>
                <button class="filter-btn" data-district="è¥¿å±¯å€">è¥¿å±¯å€</button>
                <button class="filter-btn" data-district="å—å±¯å€">å—å±¯å€</button>
                <button class="filter-btn" data-district="åŒ—å±¯å€">åŒ—å±¯å€</button>
                <button class="filter-btn" data-district="è¥¿å€">è¥¿å€</button>
                <button class="filter-btn" data-district="ä¸­å€">ä¸­å€</button>
                <button class="filter-btn" data-district="æ±å€">æ±å€</button>
                <button class="filter-btn" data-district="å—å€">å—å€</button>
                <button class="filter-btn" data-district="åŒ—å€">åŒ—å€</button>
            </div>

            <div class="filters">
                <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                <button class="filter-btn" data-filter="wifi">WiFiç©©å®š</button>
                <button class="filter-btn" data-filter="power">æ’åº§å……è¶³</button>
                <button class="filter-btn" data-filter="quiet">å®‰éœç’°å¢ƒ</button>
                <button class="filter-btn" data-filter="dessert">ç”œé»</button>
                <button class="filter-btn" data-filter="pet_friendly">å¯µç‰©å‹å–„</button>
                <button class="filter-btn" data-filter="japanese_style">æ—¥ç³»é¢¨</button>
                <button class="filter-btn" data-filter="retro">å¾©å¤</button>
            </div>
        </div>

        <div class="view-toggle">
            <button class="toggle-btn active" id="listViewBtn">ğŸ“‹æ¸…å–®æª¢è¦–</button>
            <button class="toggle-btn" id="mapViewBtn">ğŸ—ºï¸åœ°åœ–æª¢è¦–</button>
        </div>

        <div class="map-container" id="mapContainer" style="display: none;">
            <div class="map-header">
                ğŸ“å°ä¸­å’–å•¡å»³ä½ç½®åœ°åœ–
            </div>
            <div id="map"></div>
        </div>

        <div id="cafeGrid" class="cafe-grid">
            <!-- å’–å•¡å»³å¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <div id="loading" class="loading">
            è¼‰å…¥ä¸­...
        </div>

        <div id="noResults" class="no-results" style="display: none;">
            æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å’–å•¡å»³
        </div>

        <div id="error" class="error" style="display: none;">
            è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèª taichung.json æª”æ¡ˆæ˜¯å¦å­˜åœ¨
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let cafes = [];
        let filteredCafes = [];
        let currentDistrictFilter = 'all';
        let currentFeatureFilter = 'all';
        let map = null;
        let markers = [];
        let currentView = 'list';
        let isDataLoaded = false;

        // è¼‰å…¥å’–å•¡å»³è³‡æ–™
        async function loadCafeData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('cafeGrid').style.display = 'none';
                
                const response = await fetch('./taichung.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                cafes = data;
                filteredCafes = [...cafes];
                isDataLoaded = true;
                
                console.log('æˆåŠŸè¼‰å…¥å’–å•¡å»³è³‡æ–™:', cafes.length, 'ç­†');
                
                // éš±è—è¼‰å…¥ä¸­æç¤º
                document.getElementById('loading').style.display = 'none';
                
                // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
                initializeApp();
                
            } catch (error) {
                console.error('è¼‰å…¥å’–å•¡å»³è³‡æ–™å¤±æ•—:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <h3>è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤</h3>
                    <p>è«‹ç¢ºèª taichung.json æª”æ¡ˆæ˜¯å¦å­˜åœ¨æ–¼ç›¸åŒç›®éŒ„ä¸‹</p>
                    <p>éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                `;
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initializeApp() {
            if (!isDataLoaded) return;
            
            // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
            setupEventListeners();
            
            // æ¸²æŸ“å’–å•¡å»³
            renderCafes();
        }

        function renderCafes(cafesToRender = filteredCafes) {
            const grid = document.getElementById('cafeGrid');
            const noResults = document.getElementById('noResults');
            
            if (cafesToRender.length === 0) {
                grid.innerHTML = '';
                grid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noResults.style.display = 'none';

            grid.innerHTML = cafesToRender.map(cafe => `
                <div class="cafe-card" onclick="showCafeDetails(${cafe.id})">
                    <div class="cafe-content">
                        <h3 class="cafe-name">${cafe.name}</h3>
                        <div class="cafe-location">
                            <span>ğŸ“</span>
                            <span>${cafe.address}</span>
                        </div>
                        <div class="cafe-features">
                            ${cafe.features.map(feature => {
                                const featureNames = {
                                    wifi: 'WiFiç©©å®š',
                                    power: 'æ’åº§å……è¶³',
                                    quiet: 'å®‰éœç’°å¢ƒ',
                                    photo_spot: 'æ‹ç…§æ™¯é»',
                                    dessert: 'ç”œé»',
                                    mille_crepe: 'åƒå±¤è›‹ç³•',
                                    bakery: 'çƒ˜ç„™',
                                    art: 'è—è¡“ç©ºé–“',
                                    pet_friendly: 'å¯µç‰©å‹å–„',
                                    korean_style: 'éŸ“ç³»é¢¨æ ¼',
                                    photo_studio: 'æ”å½±ç©ºé–“',
                                    cozy: 'èˆ’é©',
                                    specialty_coffee: 'ç²¾å“å’–å•¡',
                                    all_day: 'å…¨å¤©ä¾›æ‡‰',
                                    creative_food: 'å‰µæ„æ–™ç†',
                                    natural_fermentation: 'è‡ªç„¶ç™¼é…µ',
                                    retro: 'å¾©å¤',
                                    japanese_style: 'æ—¥ç³»é¢¨æ ¼',
                                    reservation: 'éœ€é ç´„',
                                    camping_style: 'éœ²ç‡Ÿé¢¨æ ¼'
                                };
                                return `<span class="feature-tag ${feature}">${featureNames[feature] || feature}</span>`;
                            }).join('')}
                        </div>
                        <div class="cafe-rating">
                            <span class="stars">${generateStars(cafe.rating)}</span>
                            <span class="rating-text">${cafe.rating} (${cafe.reviews} å‰‡è©•è«–)</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = 'â˜…'.repeat(fullStars);
            if (hasHalfStar) stars += 'â˜†';
            const emptyStars = 5 - Math.ceil(rating);
            stars += 'â˜†'.repeat(emptyStars);
            return stars;
        }

        function filterCafes() {
            if (!isDataLoaded) return;
            
            let filtered = [...cafes];

            // å€åŸŸç¯©é¸
            if (currentDistrictFilter !== 'all') {
                filtered = filtered.filter(cafe => cafe.district === currentDistrictFilter);
            }

            // ç‰¹è‰²ç¯©é¸
            if (currentFeatureFilter !== 'all') {
                filtered = filtered.filter(cafe => cafe.features.includes(currentFeatureFilter));
            }

            // æœå°‹ç¯©é¸
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(cafe => 
                    cafe.name.toLowerCase().includes(searchTerm) ||
                    cafe.address.toLowerCase().includes(searchTerm)
                );
            }

            filteredCafes = filtered;
            renderCafes();
            
            // å¦‚æœæ˜¯åœ°åœ–æª¢è¦–ï¼Œæ›´æ–°åœ°åœ–æ¨™è¨˜
            if (currentView === 'map') {
                updateMapMarkers();
            }
        }

        function showCafeDetails(cafeId) {
            toggleView('map'); 
            setTimeout(() => {
                const marker = markers.find(m => m.cafeId === cafeId);
                if (marker) {
                    map.setView(marker.getLatLng(), 17); 
                    marker.openPopup();
                }
            }, 300);
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            if (map || !isDataLoaded) return; // é¿å…é‡è¤‡åˆå§‹åŒ–
            
            // ä»¥å°ä¸­å¸‚ä¸­å¿ƒç‚ºåœ°åœ–ä¸­å¿ƒ
            map = L.map('map').setView([24.1477, 120.6736], 12);
            
            // æ·»åŠ åœ°åœ–åœ–å±¤
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // æ·»åŠ å’–å•¡å»³æ¨™è¨˜
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (!map || !isDataLoaded) return;
            
            // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // æ·»åŠ æ–°æ¨™è¨˜
            filteredCafes.forEach(cafe => {
                const marker = L.marker([cafe.lat, cafe.lng]).addTo(map);
                marker.cafeId = cafe.id;
                
                const popupContent = `
                    <div class="cafe-popup">
                        <div class="popup-content">
                            <div class="popup-name">${cafe.image || 'â˜•'} ${cafe.name}</div>
                            <div class="popup-address">${cafe.address}</div>
                            <div class="popup-features">
                                ${cafe.features.map(feature => {
                                    const featureNames = {
                                        wifi: 'WiFi',
                                        power: 'æ’åº§',
                                        quiet: 'å®‰éœ',
                                        photo_spot: 'æ‹ç…§æ™¯é»',
                                        dessert: 'ç”œé»',
                                        mille_crepe: 'åƒå±¤è›‹ç³•',
                                        bakery: 'çƒ˜ç„™',
                                        art: 'è—è¡“ç©ºé–“',
                                        pet_friendly: 'å¯µç‰©å‹å–„',
                                        korean_style: 'éŸ“ç³»é¢¨æ ¼',
                                        photo_studio: 'æ”å½±ç©ºé–“',
                                        cozy: 'èˆ’é©',
                                        specialty_coffee: 'ç²¾å“å’–å•¡',
                                        all_day: 'å…¨å¤©ä¾›æ‡‰',
                                        creative_food: 'å‰µæ„æ–™ç†',
                                        natural_fermentation: 'è‡ªç„¶ç™¼é…µ',
                                        retro: 'å¾©å¤',
                                        japanese_style: 'æ—¥ç³»é¢¨æ ¼',
                                        reservation: 'éœ€é ç´„',
                                        camping_style: 'éœ²ç‡Ÿé¢¨æ ¼'
                                    };
                                    return `<span class="popup-feature">${featureNames[feature] || feature}</span>`;
                                }).join('')}
                            </div>
                            <div class="popup-rating">
                                ${generateStars(cafe.rating)} ${cafe.rating}
                            </div>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers.push(marker);
            });
            
            // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // åˆ‡æ›æª¢è¦–æ¨¡å¼
        function toggleView(viewType) {
            const listViewBtn = document.getElementById('listViewBtn');
            const mapViewBtn = document.getElementById('mapViewBtn');
            const cafeGrid = document.getElementById('cafeGrid');
            const mapContainer = document.getElementById('mapContainer');
            
            if (viewType === 'list') {
                listViewBtn.classList.add('active');
                mapViewBtn.classList.remove('active');
                cafeGrid.style.display = 'grid';
                mapContainer.style.display = 'none';
                currentView = 'list';
            } else {
                listViewBtn.classList.remove('active');
                mapViewBtn.classList.add('active');
                cafeGrid.style.display = 'none';
                mapContainer.style.display = 'block';
                currentView = 'map';
                
                // åˆå§‹åŒ–åœ°åœ–ï¼ˆå¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼‰
                setTimeout(() => {
                    initMap();
                    if (map) {
                        map.invalidateSize(); // é‡æ–°è¨ˆç®—åœ°åœ–å¤§å°
                    }
                }, 100);
            }
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æœå°‹è¼¸å…¥æ¡†
            document.getElementById('searchInput').addEventListener('input', filterCafes);

            // æª¢è¦–æ¨¡å¼åˆ‡æ›æŒ‰éˆ•
            document.getElementById('listViewBtn').addEventListener('click', () => toggleView('list'));
            document.getElementById('mapViewBtn').addEventListener('click', () => toggleView('map'));

            // å€åŸŸç¯©é¸æŒ‰éˆ•
            document.querySelectorAll('[data-district]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-district]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDistrictFilter = btn.dataset.district;
                    filterCafes();
                });
            });

            // ç‰¹è‰²ç¯©é¸æŒ‰éˆ•
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFeatureFilter = btn.dataset.filter;
                    filterCafes();
                });
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadCafeData();
        });
    </script>
</body>
</html>