<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ä¸­å’–å•¡å»³æ¨è–¦</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft JhengHei', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #4a5c6a 0%, #98a8AB  100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .search-bar {
            background: white;
            padding: 2rem;
            margin: -1rem auto 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            max-width: 850px;
            max-height: 300px;   
        }

        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            margin-bottom: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #4a5c6a;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #4a5c6a;
            color: white;
            border-color: #4a5c6a;
        }

        .cafe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .cafe-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            font-family: "Noto Sans TC", sans-serif;
            color: #333;
        }

        .cafe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .cafe-image {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        .cafe-image span {
            position: relative;
            z-index: 2;
        }

        .cafe-content {
            padding: 1.5rem;
        }

        .cafe-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .cafe-location {
            color: #666;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cafe-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .feature-tag {
            background: #f8f9fa;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .cafe-rating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .stars {
            color: #ffc107;
        }

        .rating-text {
            color: #666;
            font-size: 0.9rem;
        }

        .district-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: #dc3545;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 2rem 0;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 2rem 0;
            overflow: hidden;
        }

        .map-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #4a5c6a 0%, #98a8AB  100%);
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        #map {
            height: 400px;
            width: 100%;
        }

        .view-toggle {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            justify-content: center;
        }

        .toggle-btn {
            padding: 0.8rem 1.5rem;
            border: 2px solid #4a5c6a;
            background: white;
            color: #4a5c6a;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .toggle-btn.active {
            background: #4a5c6a;
            color: white;
        }

        .cafe-popup {
            max-width: 250px;
        }

        .popup-content {
            padding: 0.5rem 0;
        }

        .popup-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .popup-address {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .popup-features {
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .popup-feature {
            background: #f0f0f0;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .popup-rating {
            font-size: 0.9rem;
            color: #ffc107;
        }

        .score-badges {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .score-badge {
            background: #e9ecef;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #495057;
        }

        .score-badge.high {
            background: #d4edda;
            color: #155724;
        }

        .score-badge.medium {
            background: #fff3cd;
            color: #856404;
        }

        .score-badge.low {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .cafe-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><strong>å°ä¸­å’–å•¡å»³æ¨è–¦!!</strong></h1>
        </div>
    </div>

    <div class="container">
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="æœå°‹å’–å•¡å»³åç¨±æˆ–åœ°é»..." id="searchInput">
            
            <div class="district-filter">
                <button class="filter-btn active" data-district="all">å…¨éƒ¨å€åŸŸ</button>
                <button class="filter-btn" data-district="è¥¿å±¯å€">è¥¿å±¯å€</button>
                <button class="filter-btn" data-district="å—å±¯å€">å—å±¯å€</button>
                <button class="filter-btn" data-district="åŒ—å±¯å€">åŒ—å±¯å€</button>
                <button class="filter-btn" data-district="è¥¿å€">è¥¿å€</button>
                <button class="filter-btn" data-district="ä¸­å€">ä¸­å€</button>
                <button class="filter-btn" data-district="æ±å€">æ±å€</button>
                <button class="filter-btn" data-district="å—å€">å—å€</button>
                <button class="filter-btn" data-district="åŒ—å€">åŒ—å€</button>
            </div>

            <div class="filters">
                <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                <button class="filter-btn" data-filter="wifi">WiFiå„ªè‰¯</button>
                <button class="filter-btn" data-filter="seat">åº§ä½å¯¬æ•</button>
                <button class="filter-btn" data-filter="quiet">å®‰éœç’°å¢ƒ</button>
                <button class="filter-btn" data-filter="tasty">ç¾å‘³é¤é»</button>
                <button class="filter-btn" data-filter="cheap">åƒ¹ä½å¯¦æƒ </button>
                <button class="filter-btn" data-filter="music">éŸ³æ¨‚æ°›åœ</button>
            </div>
        </div>

        <div class="view-toggle">
            <button class="toggle-btn active" id="listViewBtn">ğŸ“‹æ¸…å–®æª¢è¦–</button>
            <button class="toggle-btn" id="mapViewBtn">ğŸ—ºï¸åœ°åœ–æª¢è¦–</button>
        </div>

        <div class="map-container" id="mapContainer" style="display: none;">
            <div class="map-header">
                ğŸ“å°ä¸­å’–å•¡å»³ä½ç½®åœ°åœ–
            </div>
            <div id="map"></div>
        </div>

        <div id="cafeGrid" class="cafe-grid">
            <!-- å’–å•¡å»³å¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <div id="loading" class="loading">
            è¼‰å…¥ä¸­...
        </div>

        <div id="noResults" class="no-results" style="display: none;">
            æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å’–å•¡å»³
        </div>

        <div id="error" class="error" style="display: none;">
            è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèª taichung.json æª”æ¡ˆæ˜¯å¦å­˜åœ¨
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let cafes = [];
        let filteredCafes = [];
        let currentDistrictFilter = 'all';
        let currentFeatureFilter = 'all';
        let map = null;
        let markers = [];
        let currentView = 'list';
        let isDataLoaded = false;

        // å¾åœ°å€æå–å€åŸŸ
        function extractDistrict(address) {
            const districtMatch = address.match(/([^å¸‚]+å€)/);
            return districtMatch ? districtMatch[1] : '';
        }

        // æ ¹æ“šè©•åˆ†ç²å–è©•åˆ†ç­‰ç´š
        function getScoreLevel(score) {
            if (score >= 4.5) return 'high';
            if (score >= 3.5) return 'medium';
            return 'low';
        }

        // è¼‰å…¥å’–å•¡å»³è³‡æ–™
        async function loadCafeData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('cafeGrid').style.display = 'none';
                
                const response = await fetch("https://tong127.github.io/practice/taichung.json");
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // è½‰æ›è³‡æ–™æ ¼å¼ä»¥é©é…ç¾æœ‰ç¨‹å¼ç¢¼
                cafes = data.map(cafe => ({
                    id: cafe.id,
                    name: cafe.name,
                    address: cafe.address,
                    district: extractDistrict(cafe.address),
                    lat: parseFloat(cafe.latitude),
                    lng: parseFloat(cafe.longitude),
                    wifi: cafe.wifi || 0,
                    seat: cafe.seat || 0,
                    quiet: cafe.quiet || 0,
                    tasty: cafe.tasty || 0,
                    cheap: cafe.cheap || 0,
                    music: cafe.music || 0,
                    url: cafe.url || '',
                    open_time: cafe.open_time || '',
                    limited_time: cafe.limited_time || '',
                    socket: cafe.socket || '',
                    standing_desk: cafe.standing_desk || '',
                    mrt: cafe.mrt || '',
                    // è¨ˆç®—å¹³å‡è©•åˆ†
                    rating: ((cafe.wifi + cafe.seat + cafe.quiet + cafe.tasty + cafe.cheap + cafe.music) / 6).toFixed(1),
                    reviews: Math.floor(Math.random() * 200) + 50 // æ¨¡æ“¬è©•è«–æ•¸
                }));

                filteredCafes = [...cafes];
                isDataLoaded = true;
                
                console.log('æˆåŠŸè¼‰å…¥å’–å•¡å»³è³‡æ–™:', cafes.length, 'ç­†');
                
                // éš±è—è¼‰å…¥ä¸­æç¤º
                document.getElementById('loading').style.display = 'none';
                
                // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
                initializeApp();
                
            } catch (error) {
                console.error('è¼‰å…¥å’–å•¡å»³è³‡æ–™å¤±æ•—:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <h3>è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤</h3>
                    <p>è«‹ç¢ºèª taichung.json æª”æ¡ˆæ˜¯å¦å­˜åœ¨æ–¼ç›¸åŒç›®éŒ„ä¸‹</p>
                    <p>éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                `;
            }
        }

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initializeApp() {
            if (!isDataLoaded) return;
            
            // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
            setupEventListeners();
            
            // æ¸²æŸ“å’–å•¡å»³
            renderCafes();
        }

        function renderCafes(cafesToRender = filteredCafes) {
            const grid = document.getElementById('cafeGrid');
            const noResults = document.getElementById('noResults');
            
            if (cafesToRender.length === 0) {
                grid.innerHTML = '';
                grid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noResults.style.display = 'none';

            grid.innerHTML = cafesToRender.map(cafe => `
                <div class="cafe-card" onclick="showCafeDetails('${cafe.id}')">
                    <div class="cafe-content">
                        <h3 class="cafe-name">${cafe.name}</h3>
                        <div class="cafe-location">
                            <span>ğŸ“</span>
                            <span>${cafe.address}</span>
                        </div>
                        <div class="score-badges">
                            <span class="score-badge ${getScoreLevel(cafe.wifi)}">WiFi: ${cafe.wifi}</span>
                            <span class="score-badge ${getScoreLevel(cafe.seat)}">åº§ä½: ${cafe.seat}</span>
                            <span class="score-badge ${getScoreLevel(cafe.quiet)}">å®‰éœ: ${cafe.quiet}</span>
                            <span class="score-badge ${getScoreLevel(cafe.tasty)}">ç¾å‘³: ${cafe.tasty}</span>
                            <span class="score-badge ${getScoreLevel(cafe.cheap)}">åƒ¹ä½: ${cafe.cheap}</span>
                            <span class="score-badge ${getScoreLevel(cafe.music)}">éŸ³æ¨‚: ${cafe.music}</span>
                        </div>
                        <div class="cafe-rating">
                            <span class="stars">${generateStars(cafe.rating)}</span>
                            <span class="rating-text">${cafe.rating} (${cafe.reviews} å‰‡è©•è«–)</span>
                        </div>
                        ${cafe.open_time ? `<div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">â° ${cafe.open_time}</div>` : ''}
                        ${cafe.limited_time ? `<div style="margin-top: 0.3rem; font-size: 0.8rem; color: #dc3545;">âš ï¸ ${cafe.limited_time}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = 'â˜…'.repeat(fullStars);
            if (hasHalfStar) stars += 'â˜†';
            const emptyStars = 5 - Math.ceil(rating);
            stars += 'â˜†'.repeat(emptyStars);
            return stars;
        }

        function filterCafes() {
            if (!isDataLoaded) return;
            
            let filtered = [...cafes];

            // å€åŸŸç¯©é¸
            if (currentDistrictFilter !== 'all') {
                filtered = filtered.filter(cafe => cafe.district === currentDistrictFilter);
            }

            // ç‰¹è‰²ç¯©é¸
            if (currentFeatureFilter !== 'all') {
                filtered = filtered.filter(cafe => {
                    switch(currentFeatureFilter) {
                        case 'wifi': return cafe.wifi >= 4;
                        case 'seat': return cafe.seat >= 4;
                        case 'quiet': return cafe.quiet >= 4;
                        case 'tasty': return cafe.tasty >= 4;
                        case 'cheap': return cafe.cheap >= 4;
                        case 'music': return cafe.music >= 4;
                        default: return true;
                    }
                });
            }

            // æœå°‹ç¯©é¸
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(cafe => 
                    cafe.name.toLowerCase().includes(searchTerm) ||
                    cafe.address.toLowerCase().includes(searchTerm)
                );
            }

            filteredCafes = filtered;
            renderCafes();
            
            // å¦‚æœæ˜¯åœ°åœ–æª¢è¦–ï¼Œæ›´æ–°åœ°åœ–æ¨™è¨˜
            if (currentView === 'map') {
                updateMapMarkers();
            }
        }

        function showCafeDetails(cafeId) {
            toggleView('map'); 
            setTimeout(() => {
                const marker = markers.find(m => m.cafeId === cafeId);
                if (marker) {
                    map.setView(marker.getLatLng(), 17); 
                    marker.openPopup();
                }
            }, 300);
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            if (map || !isDataLoaded) return; // é¿å…é‡è¤‡åˆå§‹åŒ–
            
            // ä»¥å°ä¸­å¸‚ä¸­å¿ƒç‚ºåœ°åœ–ä¸­å¿ƒ
            map = L.map('map').setView([24.1477, 120.6736], 12);
            
            // æ·»åŠ åœ°åœ–åœ–å±¤
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // æ·»åŠ å’–å•¡å»³æ¨™è¨˜
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (!map || !isDataLoaded) return;
            
            // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // æ·»åŠ æ–°æ¨™è¨˜
            filteredCafes.forEach(cafe => {
                const marker = L.marker([cafe.lat, cafe.lng]).addTo(map);
                marker.cafeId = cafe.id;
                
                const popupContent = `
                    <div class="cafe-popup">
                        <div class="popup-content">
                            <div class="popup-name">â˜• ${cafe.name}</div>
                            <div class="popup-address">${cafe.address}</div>
                            <div class="popup-features">
                                <span class="popup-feature">WiFi: ${cafe.wifi}</span>
                                <span class="popup-feature">åº§ä½: ${cafe.seat}</span>
                                <span class="popup-feature">å®‰éœ: ${cafe.quiet}</span>
                                <span class="popup-feature">ç¾å‘³: ${cafe.tasty}</span>
                                <span class="popup-feature">åƒ¹ä½: ${cafe.cheap}</span>
                                <span class="popup-feature">éŸ³æ¨‚: ${cafe.music}</span>
                            </div>
                            <div class="popup-rating">
                                ${generateStars(cafe.rating)} ${cafe.rating}
                            </div>
                            ${cafe.open_time ? `<div style="margin-top: 0.5rem; font-size: 0.8rem;">â° ${cafe.open_time}</div>` : ''}
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers.push(marker);
            });
            
            // èª¿æ•´åœ°åœ–è¦–é‡ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // åˆ‡æ›æª¢è¦–æ¨¡å¼
        function toggleView(viewType) {
            const listViewBtn = document.getElementById('listViewBtn');
            const mapViewBtn = document.getElementById('mapViewBtn');
            const cafeGrid = document.getElementById('cafeGrid');
            const mapContainer = document.getElementById('mapContainer');
            
            if (viewType === 'list') {
                listViewBtn.classList.add('active');
                mapViewBtn.classList.remove('active');
                cafeGrid.style.display = 'grid';
                mapContainer.style.display = 'none';
                currentView = 'list';
            } else {
                listViewBtn.classList.remove('active');
                mapViewBtn.classList.add('active');
                cafeGrid.style.display = 'none';
                mapContainer.style.display = 'block';
                currentView = 'map';
                
                // åˆå§‹åŒ–åœ°åœ–ï¼ˆå¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼‰
                setTimeout(() => {
                    initMap();
                    if (map) {
                        map.invalidateSize(); // é‡æ–°è¨ˆç®—åœ°åœ–å¤§å°
                    }
                }, 100);
            }
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æœå°‹è¼¸å…¥æ¡†
            document.getElementById('searchInput').addEventListener('input', filterCafes);

            // æª¢è¦–æ¨¡å¼åˆ‡æ›æŒ‰éˆ•
            document.getElementById('listViewBtn').addEventListener('click', () => toggleView('list'));
            document.getElementById('mapViewBtn').addEventListener('click', () => toggleView('map'));

            // å€åŸŸç¯©é¸æŒ‰éˆ•
            document.querySelectorAll('[data-district]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-district]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDistrictFilter = btn.dataset.district;
                    filterCafes();
                });
            });

            // ç‰¹è‰²ç¯©é¸æŒ‰éˆ•
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFeatureFilter = btn.dataset.filter;
                    filterCafes();
                });
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadCafeData();
        });
    </script>
</body>
</html>